# Work-Only Circuit Documentation

This document details the **Work-Only Circuit**, a specialized zero-knowledge virtual machine (zkVM) circuit designed to verify and commit the accumulated proof of work from a previously executed Bitcoin header chain circuit. Its primary purpose is to extract the `total_work` value and `genesis_state_hash` from a Header Chain Circuit proof and present them as a new, concise proof output.

## TL;DR
* **Method ID Consistency:**
    * Verifies that the `method_id` of the input `header_chain_circuit_output` matches the expected `HEADER_CHAIN_METHOD_ID` constant.

* **Previous Proof Verification:**
    * Cryptographically verifies the entire `header_chain_circuit_output` using `env::verify()`.

* **Value Extraction and Conversion:**
    * Extracts the `total_work` and `genesis_state_hash` from the verified output.
    * Converts the 256-bit `total_work` value into a 128-bit (`[u8; 16]`) representation.

## Directory Structure (Core Logic)

The core logic of the work-only circuit is organized within the [`circuits-lib/src/work_only/`](../circuits-lib/src/work_only/) directory:

```
circuits-lib/
  src/
    work_only/
      mod.rs
```

## Core Components (Core Logic)

The work-only circuit consists of a main function and a utility function that together verify the total work from a Header Chain Circuit's output.

### `mod.rs` - Work-Only Circuit Logic

This module contains the primary logic for the "work-only" circuit, responsible for processing input from a Header Chain Circuit proof and committing the derived work value.

  * **`HEADER_CHAIN_METHOD_ID: [u32; 8]`**:

      * A compile-time constant that dynamically resolves to the expected method ID of the Header Chain Circuit based on the `BITCOIN_NETWORK` environment variable (e.g., `mainnet`, `testnet4`, `signet`, `regtest`). This ensures that the circuit only verifies proofs from the correct Header Chain Circuit version for the specified network.

  * **`work_only_circuit(guest: &impl ZkvmGuest)`**:

      * The primary entry point for the "work-only" zkVM circuit.
      * It reads a `WorkOnlyCircuitInput` from the guest environment.
      * It asserts that the `method_id` of the embedded `header_chain_circuit_output` matches the `HEADER_CHAIN_METHOD_ID` constant.
      * It then verifies the entire `header_chain_circuit_output` using `env::verify()`, which cryptographically checks the proof of the preceding Header Chain Circuit.
      * The `total_work` (a `U256` value) extracted from the verified Header Chain Circuit output is converted into a 16-byte array (`[u8; 16]`).
      * Finally, it commits a `WorkOnlyCircuitOutput` containing this converted `work_u128` and the `genesis_state_hash` to the guest environment.

  * **`work_conversion(work: U256) -> [u8; 16]`**:

      * A private helper function that converts a 256-bit unsigned integer (`U256`), representing `total_work`, into a 16-byte big-endian array (`[u8; 16]`).
      * This conversion effectively truncates the `U256` to its lower 128 bits, which is then represented as a `U128` before being converted to bytes.

## Circuit Input and Output

### `WorkOnlyCircuitInput`

This struct defines the input structure for the `work_only_circuit`. It encapsulates the necessary proof and state from a prior Header Chain Circuit execution.

  * **`method_id: [u32; 8]`**: An identifier for the circuit version.
  * **`header_chain_circuit_output: BlockHeaderCircuitOutput`**: The full output of a previously run Header Chain Circuit, which includes the verified `total_work` and `genesis_state_hash`.

### `WorkOnlyCircuitOutput`

This struct defines the output generated by the `work_only_circuit` upon successful execution.

  * **`work_u128: [u8; 16]`**: The 128-bit representation of the total accumulated work from the verified header chain, serialized as a 16-byte array.
  * **`genesis_state_hash: [u8; 32]`**: The hash of the initial chain state (genesis block) as derived from the Header Chain Circuit's output.

## Error Handling and Validation

The circuit includes critical validation checks to ensure the integrity of the proofs it processes:

  * **Method ID Mismatch**: The circuit panics if the `method_id` of the `header_chain_circuit_output` provided in the input does not match the expected `HEADER_CHAIN_METHOD_ID`. This prevents the "work-only" circuit from verifying proofs generated by an incompatible version of the Header Chain Circuit.
  * **Proof Verification Failure**: The circuit will panic if `env::verify()` fails, indicating that the `header_chain_circuit_output` (the proof from the Header Chain Circuit) is invalid or has been tampered with.
  * **Serialization Errors**: Panics if serialization (`borsh::to_vec()`) fails, though this is generally considered infallible in practice for the types used.

## RISC Zero Implementation (`risc0-circuits/work-only`)

This section provides an overview of the `risc0-circuits/work-only` module, which defines the RISC Zero specific implementation and guest environment for the Work-Only Circuit.

### Key Files (RISC Zero Implementation)

  * **`risc0-circuits/work-only/guest/src/main.rs`**

      * This is the entry point for the **RISC Zero guest application**. It initializes the `Risc0Guest` environment and calls `circuits_lib::work_only::work_only_circuit` to execute the work verification logic inside the zkVM.

  * **`risc0-circuits/work-only/guest/Cargo.toml`**

      * The package manifest for the guest-side code. It defines the `work-only-guest` package and its dependencies, notably linking to `circuits-lib` which contains the core circuit logic.

  * **`risc0-circuits/work-only/src/lib.rs`**

      * This file includes the `methods.rs` generated by the build script, which contains information about the guest methods (ELF image and method ID) that the host can use to prove the guest's execution. Because we use hard-coded method IDs and ELFs that are relocated by build.rs, we rely on those instead.

  * **`risc0-circuits/work-only/build.rs`**

      * This is the **build script** for the host-side. It is responsible for:
          * Compiling the `work-only-guest` code into a RISC Zero ELF binary.
          * Computing the unique **method ID** for the compiled guest program.
          * Handling environment variables (like `BITCOIN_NETWORK` and `REPR_GUEST_BUILD`) to configure the build process, including optional Docker usage.
          * Copying the generated ELF binary to a designated `elfs` folder.

  * **`risc0-circuits/work-only/Cargo.toml`**

      * The package manifest for the host-side crate. It defines the `work-only` package and its build-time dependencies, including `risc0-build` for the RISC Zero toolchain integration.

-----