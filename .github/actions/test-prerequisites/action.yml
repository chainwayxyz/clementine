# Start required services for testing Clementine.

name: Clementine Test Services
description: "Start services required for testing Clementine"

inputs:
  github_token:
    description: "GitHub token for authentication"
    required: true

runs:
  using: "composite"

  steps:
    - name: Cache bitvm cache files
      uses: actions/cache@v4
      id: cache-bitvm
      with:
        path: |
          core/bitvm_cache.bin
          core/bitvm_cache_dev.bin
        key: bitvm-cache-23-10-2025

    - name: Download bitvm cache bin
      if: steps.cache-bitvm.outputs.cache-hit != 'true'
      shell: bash
      run: wget https://static.citrea.xyz/test-net/clementine/conf/bitvm_cache.bin -O core/bitvm_cache.bin

    - name: Download bitvm cache dev bin
      if: steps.cache-bitvm.outputs.cache-hit != 'true'
      shell: bash
      run: wget https://static.citrea.xyz/dev-net/clementine/conf/bitvm_cache_dev.bin -O core/bitvm_cache_dev.bin

    - name: Cache Bitcoin binaries
      uses: actions/cache@v4
      id: cache-bitcoin
      with:
        path: |
          bitcoin-29.0-x86_64-linux-gnu.tar.gz
          bitcoin-29.0/
        key: bitcoin-29.0-x86_64-linux-gnu

    - name: Download Bitcoin
      if: steps.cache-bitcoin.outputs.cache-hit != 'true'
      shell: bash
      run: wget https://bitcoincore.org/bin/bitcoin-core-29.0/bitcoin-29.0-x86_64-linux-gnu.tar.gz

    - name: Unpack Bitcoin
      if: steps.cache-bitcoin.outputs.cache-hit != 'true'
      shell: bash
      run: tar -xzvf bitcoin-29.0-x86_64-linux-gnu.tar.gz

    - name: Set executable permissions
      shell: bash
      run: chmod +x bitcoin-29.0/bin/*

    - name: Add bitcoin to path
      shell: bash
      run: echo "$PWD/bitcoin-29.0/bin" >> $GITHUB_PATH

    - name: Install risc0
      shell: bash
      env:
        GITHUB_TOKEN: ${{ inputs.github_token }}
      run: |
        curl -L https://risczero.com/install | bash
        export PATH="$PATH:$HOME/.risc0/bin"
        rzup install
        rzup install rust 1.88.0

    - name: Install udocker dependencies
      shell: bash
      run: |
        sudo apt-get update
        sudo apt-get install -y python3 python-is-python3 tar skopeo curl

    - name: Install udocker
      shell: bash
      run: |
        wget -q https://github.com/indigo-dc/udocker/releases/download/1.3.17/udocker-1.3.17.tar.gz
        sudo tar -xzf udocker-1.3.17.tar.gz -C /opt/
        rm udocker-1.3.17.tar.gz
        echo "/opt/udocker-1.3.17/udocker" >> $GITHUB_PATH

    - name: Initialize udocker
      shell: bash
      run: |
        sudo /opt/udocker-1.3.17/udocker/udocker --allow-root install
