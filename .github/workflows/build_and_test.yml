name: Build And Test

on: [push]

env:
  CARGO_TERM_COLOR: always
  CARGOFLAGS: --workspace --all-targets --all-features
  RUST_LOG: trace,risc0_zkvm=error,risc0_circuit_rv32im=error
  RISC0_DEV_MODE: 1

jobs:
# Build ------------------------------------------------------------------------
  debug_build:
    name: Compile code with debug profile
    runs-on: ubicloud-standard-16

    steps:
    - uses: actions/checkout@v4
    - uses: ./.github/actions/build-prerequisites

    - name: Save build artifacts
      uses: Swatinem/rust-cache@v2
      with:
        shared-key: "debug-build"

    - name: Compile in debug mode
      run: cargo build $CARGOFLAGS --verbose

  release_build:
    name: Compile code with release profile
    runs-on: ubicloud-standard-16

    steps:
    - uses: actions/checkout@v4
    - uses: ./.github/actions/build-prerequisites

    - name: Save build artifacts
      uses: Swatinem/rust-cache@v2
      with:
        shared-key: "release-build"

    - name: Compile in release mode
      run: cargo build $CARGOFLAGS --verbose --release

# Tests ------------------------------------------------------------------------
  debug_build_test:
    name: Test code with debug build
    runs-on: ubicloud-standard-16
    needs: debug_build

    services:
      postgres:
        image: postgres:latest
        env:
          POSTGRES_DB: clementine
          POSTGRES_USER: clementine
          POSTGRES_PASSWORD: clementine
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - uses: actions/checkout@v4
    - uses: ./.github/actions/build-prerequisites
    - uses: ./.github/actions/test-prerequisites

    - name: Restore cached build artifacts
      uses: Swatinem/rust-cache@v2
      with:
        shared-key: "debug-build"

    - name: Run tests
      run: cargo test

  release_build_test:
    name: Test code with release build
    runs-on: ubicloud-standard-16
    needs: release_build

    services:
      postgres:
        image: postgres:latest
        env:
          POSTGRES_DB: clementine
          POSTGRES_USER: clementine
          POSTGRES_PASSWORD: clementine
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - uses: actions/checkout@v4
    - uses: ./.github/actions/build-prerequisites
    - uses: ./.github/actions/test-prerequisites

    - name: Restore cached build artifacts
      uses: Swatinem/rust-cache@v2
      with:
        shared-key: "release-build"

    - name: Run tests
      run: cargo test --release
